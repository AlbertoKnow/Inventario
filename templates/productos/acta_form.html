{% extends "base.html" %}

{% block title %}Nueva Acta de {{ tipo_acta|title }}{% endblock %}

{% block extra_css %}
<style>
    /* Wizard Steps */
    .wizard-steps {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }
    .wizard-step {
        display: flex;
        align-items: center;
        color: var(--gray-400);
    }
    .wizard-step .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 0.5rem;
    }
    .wizard-step.active .step-number {
        background: var(--accent);
        color: white;
    }
    .wizard-step.completed .step-number {
        background: var(--success);
        color: white;
    }
    .wizard-step.active {
        color: var(--gray-900);
    }
    .wizard-step.completed {
        color: var(--success);
    }
    .wizard-connector {
        width: 60px;
        height: 2px;
        background: var(--gray-200);
        margin: 0 1rem;
    }
    .wizard-connector.completed {
        background: var(--success);
    }

    /* Signature Canvas */
    .signature-container {
        border: 2px dashed var(--gray-300);
        border-radius: 8px;
        background: #fafafa;
    }
    .signature-canvas {
        width: 100%;
        height: 200px;
        cursor: crosshair;
    }

    /* Item Selection */
    .item-card {
        border: 2px solid var(--gray-200);
        border-radius: 10px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .item-card:hover {
        border-color: var(--accent);
        background: #fef2f2;
    }
    .item-card.selected {
        border-color: var(--accent);
        background: #fef2f2;
    }
    .item-card input[type="checkbox"] {
        display: none;
    }

    /* Photo preview */
    .photo-preview {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid var(--gray-200);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'productos:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'productos:acta-list' %}">Actas</a></li>
            <li class="breadcrumb-item active">Nueva Acta</li>
        </ol>
    </nav>

    <div class="page-header mb-4">
        <h1>Nueva Acta de {{ tipo_acta|title }}</h1>
        <p class="text-muted">Complete los pasos para generar el acta</p>
    </div>

    <!-- Wizard Steps -->
    <div class="wizard-steps">
        <div class="wizard-step {% if paso == 1 %}active{% elif paso > 1 %}completed{% endif %}">
            <span class="step-number">{% if paso > 1 %}<i class="fas fa-check"></i>{% else %}1{% endif %}</span>
            <span>Colaborador</span>
        </div>
        <div class="wizard-connector {% if paso > 1 %}completed{% endif %}"></div>
        <div class="wizard-step {% if paso == 2 %}active{% elif paso > 2 %}completed{% endif %}">
            <span class="step-number">{% if paso > 2 %}<i class="fas fa-check"></i>{% else %}2{% endif %}</span>
            <span>Equipos</span>
        </div>
        <div class="wizard-connector {% if paso > 2 %}completed{% endif %}"></div>
        <div class="wizard-step {% if paso == 3 %}active{% endif %}">
            <span class="step-number">3</span>
            <span>Firmas</span>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="actaForm">
        {% csrf_token %}
        <input type="hidden" name="paso" value="{{ paso }}">
        <input type="hidden" name="tipo" value="{{ tipo_acta }}">

        {% if paso == 1 %}
        <!-- PASO 1: Seleccionar Colaborador -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-user me-2"></i>Paso 1: Seleccionar Colaborador
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Tipo de Acta -->
                    <div class="col-md-6">
                        <label class="form-label">Tipo de Acta *</label>
                        <select name="tipo" class="form-select" required>
                            <option value="entrega" {% if tipo_acta == 'entrega' %}selected{% endif %}>Entrega</option>
                            <option value="devolucion" {% if tipo_acta == 'devolucion' %}selected{% endif %}>Devolución</option>
                        </select>
                    </div>

                    <!-- Ticket -->
                    <div class="col-md-6">
                        <label class="form-label">Ticket de Referencia</label>
                        <input type="text" name="ticket" class="form-control"
                               value="{{ datos_sesion.ticket }}" placeholder="Ej: INC00012345">
                    </div>

                    <!-- Búsqueda de Colaborador -->
                    <div class="col-12">
                        <label class="form-label">Buscar Colaborador *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="buscarColaborador" class="form-control"
                                   placeholder="Buscar por DNI o nombre...">
                        </div>
                    </div>

                    <!-- Colaborador Seleccionado o Nuevo -->
                    <div class="col-12">
                        <div id="colaboradorSeleccionado" style="display: none;">
                            <div class="alert alert-info d-flex justify-content-between align-items-center">
                                <div>
                                    <strong id="nombreColaborador"></strong>
                                    <br><small id="datosColaborador"></small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limpiarColaborador()">
                                    <i class="fas fa-times"></i> Cambiar
                                </button>
                            </div>
                            <input type="hidden" name="colaborador_id" id="colaboradorId">
                        </div>

                        <div id="nuevoColaborador">
                            <div class="alert alert-secondary">
                                <i class="fas fa-info-circle me-2"></i>
                                Busque un colaborador existente o complete los datos para crear uno nuevo.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">DNI *</label>
                                    <input type="text" name="dni" class="form-control"
                                           value="{{ datos_sesion.dni }}" maxlength="15" required>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Nombre Completo *</label>
                                    <input type="text" name="nombre_completo" class="form-control"
                                           value="{{ datos_sesion.nombre_completo }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Cargo *</label>
                                    <input type="text" name="cargo" class="form-control"
                                           value="{{ datos_sesion.cargo }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Gerencia *</label>
                                    <select name="gerencia" class="form-select" required>
                                        <option value="">Seleccione...</option>
                                        {% for g in gerencias %}
                                        <option value="{{ g.id }}" {% if datos_sesion.gerencia == g.id|stringformat:"i" %}selected{% endif %}>
                                            {{ g.nombre }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Sede *</label>
                                    <select name="sede" class="form-select" required>
                                        <option value="">Seleccione...</option>
                                        {% for s in sedes %}
                                        <option value="{{ s.id }}" {% if datos_sesion.sede == s.id|stringformat:"i" %}selected{% endif %}>
                                            {{ s.nombre }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Correo Electrónico *</label>
                                    <input type="email" name="correo" class="form-control"
                                           value="{{ datos_sesion.correo }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Anexo / RPE</label>
                                    <input type="text" name="anexo" class="form-control"
                                           value="{{ datos_sesion.anexo }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="col-12">
                        <label class="form-label">Observaciones</label>
                        <textarea name="observaciones" class="form-control" rows="2">{{ datos_sesion.observaciones }}</textarea>
                    </div>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between">
                <a href="{% url 'productos:acta-list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-1"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    Siguiente <i class="fas fa-arrow-right ms-1"></i>
                </button>
            </div>
        </div>

        {% elif paso == 2 %}
        <!-- PASO 2: Seleccionar Equipos y Accesorios -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-laptop me-2"></i>Paso 2: Seleccionar Equipos
            </div>
            <div class="card-body">
                <!-- Info del colaborador -->
                <div class="alert alert-info mb-4">
                    <strong>Colaborador:</strong> {{ colaborador.nombre_completo }} ({{ colaborador.dni }})
                    <br><small>{{ colaborador.cargo }} - {{ colaborador.gerencia.nombre }}</small>
                </div>

                <!-- Búsqueda de Items -->
                <div class="mb-4">
                    <label class="form-label">Buscar Equipos</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="buscarItem" class="form-control"
                               placeholder="Buscar por código, serie o nombre...">
                    </div>
                </div>

                <!-- Items Disponibles -->
                <div id="itemsDisponibles" class="row g-3 mb-4">
                    {% for item in items_disponibles %}
                    <div class="col-md-6">
                        <label class="item-card d-block">
                            <input type="checkbox" name="items[]" value="{{ item.id }}"
                                   {% if item.id in items_seleccionados %}checked{% endif %}>
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>{{ item.codigo_interno }}</strong>
                                    <br><span class="text-muted">{{ item.nombre }}</span>
                                    {% if item.especificaciones_sistemas %}
                                    <br><small>{{ item.especificaciones_sistemas.marca }} {{ item.especificaciones_sistemas.modelo }}</small>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">Serie: {{ item.serie }}</small>
                                    <br>
                                    {% if item.estado == 'nuevo' %}
                                    <span class="badge bg-success">Nuevo</span>
                                    {% elif item.estado == 'instalado' %}
                                    <span class="badge bg-primary">Instalado</span>
                                    {% endif %}
                                </div>
                            </div>
                        </label>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center text-muted py-4">
                        <i class="fas fa-box-open fa-2x mb-2"></i>
                        <p>No hay equipos disponibles para asignar</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Accesorios por Item (se muestra dinámicamente) -->
                <div id="accesoriosContainer" style="display: none;">
                    <hr>
                    <h5><i class="fas fa-plug me-2"></i>Accesorios por Equipo</h5>
                    <div id="accesoriosList"></div>
                </div>
            </div>
        </div>

        <!-- Software -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-compact-disc me-2"></i>Software Instalado
            </div>
            <div class="card-body">
                <div class="row g-2">
                    {% for sw in software_list %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="software[]"
                                   value="{{ sw.id }}" id="sw{{ sw.id }}"
                                   {% if sw.es_basico %}checked{% endif %}>
                            <label class="form-check-label" for="sw{{ sw.id }}">
                                {{ sw.nombre }}
                                {% if sw.es_basico %}<small class="text-muted">(Básico)</small>{% endif %}
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Fotos -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-camera me-2"></i>Fotos del Equipo (Opcional)
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Foto 1</label>
                        <input type="file" name="foto1" class="form-control" accept="image/*">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Foto 2</label>
                        <input type="file" name="foto2" class="form-control" accept="image/*">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Foto 3</label>
                        <input type="file" name="foto3" class="form-control" accept="image/*">
                    </div>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between">
                <button type="submit" name="volver" value="1" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Anterior
                </button>
                <button type="submit" class="btn btn-primary">
                    Siguiente <i class="fas fa-arrow-right ms-1"></i>
                </button>
            </div>
        </div>

        {% elif paso == 3 %}
        <!-- PASO 3: Firmas -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-signature me-2"></i>Paso 3: Firmas
            </div>
            <div class="card-body">
                <!-- Resumen -->
                <div class="alert alert-info mb-4">
                    <h6>Resumen del Acta</h6>
                    <strong>Tipo:</strong> {{ tipo_acta|title }}<br>
                    <strong>Colaborador:</strong> {{ colaborador.nombre_completo }} ({{ colaborador.dni }})<br>
                    <strong>Equipos:</strong> {{ items_seleccionados|length }} ítem(s)
                </div>

                <div class="row g-4">
                    <!-- Firma del Receptor -->
                    <div class="col-md-6">
                        <label class="form-label">Firma del Receptor ({{ colaborador.nombre_completo }}) *</label>
                        <div class="signature-container">
                            <canvas id="firmaReceptor" class="signature-canvas"></canvas>
                        </div>
                        <input type="hidden" name="firma_receptor" id="firmaReceptorData">
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="limpiarFirma('firmaReceptor')">
                            <i class="fas fa-eraser me-1"></i> Limpiar
                        </button>
                    </div>

                    <!-- Firma del Emisor -->
                    <div class="col-md-6">
                        <label class="form-label">Firma del Emisor ({{ request.user.get_full_name|default:request.user.username }}) *</label>
                        <div class="signature-container">
                            <canvas id="firmaEmisor" class="signature-canvas"></canvas>
                        </div>
                        <input type="hidden" name="firma_emisor" id="firmaEmisorData">
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="limpiarFirma('firmaEmisor')">
                            <i class="fas fa-eraser me-1"></i> Limpiar
                        </button>
                    </div>
                </div>

                <!-- Checkbox de envío de correo -->
                <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" name="enviar_correo" id="enviarCorreo" checked>
                    <label class="form-check-label" for="enviarCorreo">
                        Enviar acta por correo electrónico al colaborador
                    </label>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between">
                <button type="submit" name="volver" value="2" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Anterior
                </button>
                <button type="submit" class="btn btn-success" onclick="return validarFirmas()">
                    <i class="fas fa-check me-1"></i> Generar Acta
                </button>
            </div>
        </div>
        {% endif %}
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
{% if paso == 1 %}
// Búsqueda de colaborador
const buscarInput = document.getElementById('buscarColaborador');
let timeoutId;

buscarInput.addEventListener('input', function() {
    clearTimeout(timeoutId);
    const query = this.value.trim();

    if (query.length < 3) return;

    timeoutId = setTimeout(() => {
        fetch(`{% url 'productos:api-colaboradores-buscar' %}?q=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(data => {
                if (data.colaboradores && data.colaboradores.length > 0) {
                    // Mostrar sugerencias
                    mostrarSugerencias(data.colaboradores);
                }
            });
    }, 300);
});

function mostrarSugerencias(colaboradores) {
    // Implementar dropdown de sugerencias
    const col = colaboradores[0];
    seleccionarColaborador(col);
}

function seleccionarColaborador(col) {
    document.getElementById('colaboradorSeleccionado').style.display = 'block';
    document.getElementById('nuevoColaborador').style.display = 'none';
    document.getElementById('colaboradorId').value = col.id;
    document.getElementById('nombreColaborador').textContent = col.nombre_completo;
    document.getElementById('datosColaborador').textContent =
        `DNI: ${col.dni} | ${col.cargo} | ${col.gerencia}`;
}

function limpiarColaborador() {
    document.getElementById('colaboradorSeleccionado').style.display = 'none';
    document.getElementById('nuevoColaborador').style.display = 'block';
    document.getElementById('colaboradorId').value = '';
}
{% endif %}

{% if paso == 2 %}
// Manejo de selección de items
document.querySelectorAll('.item-card').forEach(card => {
    const checkbox = card.querySelector('input[type="checkbox"]');

    if (checkbox.checked) {
        card.classList.add('selected');
    }

    card.addEventListener('click', function(e) {
        if (e.target.type !== 'checkbox') {
            checkbox.checked = !checkbox.checked;
        }
        card.classList.toggle('selected', checkbox.checked);
        actualizarAccesorios();
    });
});

function actualizarAccesorios() {
    const container = document.getElementById('accesoriosContainer');
    const list = document.getElementById('accesoriosList');
    const checkedItems = document.querySelectorAll('.item-card input:checked');

    if (checkedItems.length === 0) {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'block';
    list.innerHTML = '';

    checkedItems.forEach((checkbox, index) => {
        const itemId = checkbox.value;
        const card = checkbox.closest('.item-card');
        const itemName = card.querySelector('strong').textContent;

        list.innerHTML += `
            <div class="border rounded p-3 mb-3">
                <h6>${itemName}</h6>
                <div class="row g-2">
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="acc_${itemId}_cargador" id="acc_${itemId}_cargador" checked>
                            <label class="form-check-label" for="acc_${itemId}_cargador">Cargador / Cables</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="acc_${itemId}_cable_seguridad" id="acc_${itemId}_cable_seguridad">
                            <label class="form-check-label" for="acc_${itemId}_cable_seguridad">Cable de seguridad</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="acc_${itemId}_bateria" id="acc_${itemId}_bateria" checked>
                            <label class="form-check-label" for="acc_${itemId}_bateria">Batería</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="acc_${itemId}_maletin" id="acc_${itemId}_maletin">
                            <label class="form-check-label" for="acc_${itemId}_maletin">Maletín</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="acc_${itemId}_cable_red" id="acc_${itemId}_cable_red">
                            <label class="form-check-label" for="acc_${itemId}_cable_red">Cable de red</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="acc_${itemId}_teclado_mouse" id="acc_${itemId}_teclado_mouse">
                            <label class="form-check-label" for="acc_${itemId}_teclado_mouse">Teclado y Mouse</label>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
}

// Inicializar accesorios
actualizarAccesorios();
{% endif %}

{% if paso == 3 %}
// Canvas de firma
class SignaturePad {
    constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        this.isDrawing = false;
        this.lastX = 0;
        this.lastY = 0;

        this.resize();
        window.addEventListener('resize', () => this.resize());

        this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
        this.canvas.addEventListener('mousemove', (e) => this.draw(e));
        this.canvas.addEventListener('mouseup', () => this.stopDrawing());
        this.canvas.addEventListener('mouseout', () => this.stopDrawing());

        // Touch events
        this.canvas.addEventListener('touchstart', (e) => this.startDrawing(e));
        this.canvas.addEventListener('touchmove', (e) => this.draw(e));
        this.canvas.addEventListener('touchend', () => this.stopDrawing());

        this.ctx.strokeStyle = '#000';
        this.ctx.lineWidth = 2;
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
    }

    resize() {
        const rect = this.canvas.getBoundingClientRect();
        this.canvas.width = rect.width;
        this.canvas.height = 200;
    }

    getPos(e) {
        const rect = this.canvas.getBoundingClientRect();
        if (e.touches) {
            return {
                x: e.touches[0].clientX - rect.left,
                y: e.touches[0].clientY - rect.top
            };
        }
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
    }

    startDrawing(e) {
        e.preventDefault();
        this.isDrawing = true;
        const pos = this.getPos(e);
        this.lastX = pos.x;
        this.lastY = pos.y;
    }

    draw(e) {
        if (!this.isDrawing) return;
        e.preventDefault();
        const pos = this.getPos(e);
        this.ctx.beginPath();
        this.ctx.moveTo(this.lastX, this.lastY);
        this.ctx.lineTo(pos.x, pos.y);
        this.ctx.stroke();
        this.lastX = pos.x;
        this.lastY = pos.y;
    }

    stopDrawing() {
        this.isDrawing = false;
    }

    clear() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }

    isEmpty() {
        const pixelData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height).data;
        return !pixelData.some(channel => channel !== 0);
    }

    toDataURL() {
        return this.canvas.toDataURL('image/png');
    }
}

const padReceptor = new SignaturePad('firmaReceptor');
const padEmisor = new SignaturePad('firmaEmisor');

function limpiarFirma(canvasId) {
    if (canvasId === 'firmaReceptor') {
        padReceptor.clear();
    } else {
        padEmisor.clear();
    }
}

function validarFirmas() {
    if (padReceptor.isEmpty()) {
        alert('Por favor, capture la firma del receptor.');
        return false;
    }
    if (padEmisor.isEmpty()) {
        alert('Por favor, capture la firma del emisor.');
        return false;
    }

    document.getElementById('firmaReceptorData').value = padReceptor.toDataURL();
    document.getElementById('firmaEmisorData').value = padEmisor.toDataURL();
    return true;
}
{% endif %}
</script>
{% endblock %}
