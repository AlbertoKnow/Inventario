{% extends "base.html" %}

{% block title %}Nuevo Movimiento{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para el flujo de aprobación */
    .step-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        flex-shrink: 0;
        position: relative;
        z-index: 1;
    }

    .step-icon.step-active {
        background: linear-gradient(135deg, var(--accent) 0%, #e8354d 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(200, 16, 46, 0.3);
    }

    .step-icon.step-pending {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .step-icon.step-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .step-connector {
        position: absolute;
        left: 19px;
        top: 40px;
        width: 2px;
        height: 30px;
        background: linear-gradient(to bottom, var(--gray-300), var(--gray-200));
    }

    .d-flex.align-items-center.mb-3 {
        position: relative;
    }

    .tipo-card {
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
    }
    .tipo-card:hover {
        border-color: var(--accent);
        background-color: rgba(200, 16, 46, 0.05);
    }
    .tipo-card.selected {
        border-color: var(--accent);
        background-color: rgba(200, 16, 46, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'productos:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'productos:movimiento-list' %}">Movimientos</a></li>
            <li class="breadcrumb-item active">Nuevo Movimiento</li>
        </ol>
    </nav>

    <div class="page-header mb-4">
        <h1>Solicitar Movimiento</h1>
        <p class="text-muted">
            {% if item %}
            Para el ítem: <strong>{{ item.codigo_utp }}</strong> - {{ item.nombre }}
            {% else %}
            Registra una solicitud de movimiento de inventario
            {% endif %}
        </p>
    </div>

    <form method="post" enctype="multipart/form-data" id="movimientoForm">
        {% csrf_token %}

        {% if form.errors %}
        <div class="alert alert-danger mb-4">
            <i class="fas fa-exclamation-circle me-2"></i>
            Por favor corrige los errores indicados.
            <ul class="mb-0 mt-2">
                {% for field in form %}
                    {% for error in field.errors %}
                    <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="row">
            <div class="col-lg-8">
                <!-- Buscar y Seleccionar Ítems -->
                {% if not item %}
                <div class="card mb-4" id="cardBusquedaItems">
                    <div class="card-header">
                        <i class="fas fa-search me-2"></i>Buscar y Agregar Ítems
                    </div>
                    <div class="card-body">
                        <!-- Campo de búsqueda con autocompletado -->
                        <div class="mb-3">
                            <label class="form-label">Buscar por Código UTP, Serie o Nombre</label>
                            <div class="position-relative">
                                <input type="text"
                                       class="form-control"
                                       id="buscarItem"
                                       placeholder="Escribe para buscar y agregar ítems..."
                                       autocomplete="off">
                                <div id="sugerenciasItem" class="list-group position-absolute w-100 shadow" style="z-index: 1000; max-height: 300px; overflow-y: auto; display: none;"></div>
                            </div>
                            <small class="text-muted">Puedes agregar múltiples ítems al movimiento</small>
                        </div>

                        <!-- Filtros opcionales (colapsables) -->
                        <div class="mt-3">
                            <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" href="#filtrosAvanzados" role="button">
                                <i class="fas fa-filter me-1"></i>Filtros avanzados
                            </a>
                            <div class="collapse mt-3" id="filtrosAvanzados">
                                <div class="card card-body bg-light">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Campus</label>
                                            <select class="form-select form-select-sm" id="filtro_campus">
                                                <option value="">Todos</option>
                                                {% for campus in campus_list %}
                                                <option value="{{ campus.id }}">{{ campus.nombre }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Sede</label>
                                            <select class="form-select form-select-sm" id="filtro_sede" disabled>
                                                <option value="">Todas</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Área</label>
                                            <select class="form-select form-select-sm" id="filtro_area">
                                                <option value="">Todas</option>
                                                {% for area in areas_list %}
                                                <option value="{{ area.id }}">{{ area.nombre }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Tipo de Ítem</label>
                                            <select class="form-select form-select-sm" id="filtro_tipo">
                                                <option value="">Todos</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-sm btn-primary" id="btnBuscarConFiltros">
                                            <i class="fas fa-search me-1"></i>Buscar con filtros
                                        </button>
                                        <button type="button" class="btn btn-sm btn-light" id="btnLimpiarFiltros">
                                            <i class="fas fa-times me-1"></i>Limpiar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Ítem preseleccionado -->
                <input type="hidden" name="items" value="{{ item.pk }}">
                {% endif %}

                <!-- Panel de Ítems Seleccionados -->
                <div class="card mb-4" id="panelItemsSeleccionados">
                    <div class="card-header bg-success bg-opacity-10 d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-boxes me-2"></i>Ítems Seleccionados
                            <span class="badge bg-primary ms-2" id="contadorItems">{% if item %}1{% else %}0{% endif %}</span>
                        </span>
                        {% if not item %}
                        <button type="button" class="btn btn-sm btn-outline-danger" id="btnLimpiarItems" style="display: none;">
                            <i class="fas fa-trash me-1"></i>Limpiar todos
                        </button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <!-- Contenedor de campos hidden para los items -->
                        <div id="itemsHiddenContainer">
                            {% if item %}
                            <input type="hidden" name="items" value="{{ item.pk }}" data-item-id="{{ item.pk }}">
                            {% endif %}
                        </div>

                        <!-- Lista visual de ítems seleccionados -->
                        <div id="listaItemsSeleccionados">
                            {% if item %}
                            <div class="item-seleccionado border rounded p-3 mb-2" data-item-id="{{ item.pk }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>{{ item.codigo_utp }}</strong> - {{ item.nombre }}
                                        <br><small class="text-muted">Serie: {{ item.serie|default:"-" }} | {{ item.area.nombre }}</small>
                                        <br><small class="text-muted">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            {% if item.ambiente %}
                                            {{ item.ambiente.pabellon.sede.campus.nombre }} &raquo;
                                            {{ item.ambiente.pabellon.sede.nombre }} &raquo;
                                            Pab. {{ item.ambiente.pabellon.letra }} - {{ item.ambiente.nombre }}
                                            {% else %}
                                            Sin ubicación
                                            {% endif %}
                                        </small>
                                    </div>
                                    <span class="badge bg-secondary">{{ item.get_estado_display }}</span>
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-4" id="mensajeSinItems">
                                <i class="fas fa-inbox fa-3x mb-3 d-block opacity-50"></i>
                                <p class="mb-0">No hay ítems seleccionados</p>
                                <small>Usa el buscador de arriba para agregar ítems al movimiento</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Tipo de Movimiento -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-exchange-alt me-2"></i>Tipo de Movimiento
                    </div>
                    <div class="card-body">
                        <label class="form-label">Tipo <span class="text-danger">*</span></label>
                        {{ form.tipo }}
                    </div>
                </div>

                <!-- Ubicación Destino (para traslados) -->
                <div class="card mb-4" id="seccionDestino">
                    <div class="card-header">
                        <i class="fas fa-map-marker-alt me-2"></i>Ubicación Destino
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Campus</label>
                                {{ form.campus_destino }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Sede</label>
                                {{ form.sede_destino }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pabellón</label>
                                {{ form.pabellon_destino }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ambiente <span class="text-danger">*</span></label>
                                {{ form.ambiente_destino }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Asignación a Colaborador (para asignación/préstamo) -->
                <div class="card mb-4" id="seccionColaborador" style="display: none;">
                    <div class="card-header">
                        <i class="fas fa-user me-2"></i>Asignar a Colaborador
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Colaborador <span class="text-danger">*</span></label>
                                {{ form.colaborador_nuevo }}
                            </div>
                            <div class="col-md-4" id="campoFechaDevolucion" style="display: none;">
                                <label class="form-label">Fecha de Devolución <span class="text-danger">*</span></label>
                                {{ form.fecha_devolucion_esperada }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ítem de Reemplazo (para mantenimiento/garantía/reemplazo) -->
                <div class="card mb-4" id="seccionReemplazo" style="display: none;">
                    <div class="card-header">
                        <i class="fas fa-sync-alt me-2"></i>Ítem de Reemplazo
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Ítem de Reemplazo</label>
                                {{ form.item_reemplazo }}
                                <small class="text-muted">Selecciona un ítem de backup o custodia para entregar como reemplazo</small>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mt-4 pt-2">
                                    {{ form.reemplazo_es_temporal }}
                                    <label class="form-check-label" for="id_reemplazo_es_temporal">
                                        Es reemplazo temporal
                                    </label>
                                </div>
                                <small class="text-muted">Marcar si el equipo original regresará</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estado Final del Ítem -->
                <div class="card mb-4" id="seccionEstadoFinal" style="display: none;">
                    <div class="card-header">
                        <i class="fas fa-tag me-2"></i>Estado Final del Ítem
                    </div>
                    <div class="card-body">
                        <label class="form-label">Nuevo Estado</label>
                        {{ form.estado_item_destino }}
                        <small class="text-muted">Estado en que quedará el ítem al ejecutarse el movimiento</small>
                    </div>
                </div>

                <!-- Motivo y Detalles -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-file-alt me-2"></i>Detalles del Movimiento
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Motivo <span class="text-danger">*</span></label>
                                {{ form.motivo }}
                                <small class="text-muted">Describe el motivo del movimiento</small>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Observaciones</label>
                                {{ form.observaciones }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Info del Flujo -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-route me-2"></i>Flujo de Aprobación
                    </div>
                    <div class="card-body">
                        <!-- Paso 1: Solicitud -->
                        <div class="d-flex align-items-center mb-3">
                            <div class="step-icon step-active">
                                <i class="fas fa-paper-plane"></i>
                            </div>
                            <div class="step-connector"></div>
                            <div class="ms-3">
                                <small class="text-muted d-block">Paso 1</small>
                                <span class="fw-medium">Enviar solicitud</span>
                            </div>
                        </div>

                        <!-- Paso 2: Aprobación -->
                        <div class="d-flex align-items-center mb-3">
                            <div class="step-icon step-pending">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="step-connector"></div>
                            <div class="ms-3">
                                <small class="text-muted d-block">Paso 2</small>
                                <span class="fw-medium">Aprobación por Supervisor</span>
                            </div>
                        </div>

                        <!-- Paso 3: En Ejecución -->
                        <div class="d-flex align-items-center mb-3">
                            <div class="step-icon step-pending">
                                <i class="fas fa-tools"></i>
                            </div>
                            <div class="step-connector"></div>
                            <div class="ms-3">
                                <small class="text-muted d-block">Paso 3</small>
                                <span class="fw-medium">Retirar equipo (En Ejecución)</span>
                            </div>
                        </div>

                        <!-- Paso 4: En Tránsito (condicional) -->
                        <div class="d-flex align-items-center mb-3" id="pasoTransito">
                            <div class="step-icon step-pending">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="step-connector"></div>
                            <div class="ms-3">
                                <small class="text-muted d-block">Paso 4</small>
                                <span class="fw-medium">En Tránsito (entre campus)</span>
                            </div>
                        </div>

                        <!-- Paso 5: Ejecutado -->
                        <div class="d-flex align-items-center">
                            <div class="step-icon step-success">
                                <i class="fas fa-flag-checkered"></i>
                            </div>
                            <div class="ms-3">
                                <small class="text-muted d-block">Paso Final</small>
                                <span class="fw-medium">Confirmar recepción (Ejecutado)</span>
                            </div>
                        </div>

                        <hr>

                        <div class="alert alert-info mb-0 small">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Nota:</strong> Todos los movimientos requieren aprobación del Supervisor o Gerente del área.
                        </div>
                    </div>
                </div>

                <!-- Leyenda de tipos -->
                <div class="card mb-4">
                    <div class="card-header">Tipos de Movimiento</div>
                    <div class="card-body small">
                        <p><strong>Traslado:</strong> Mover ítem a otra ubicación</p>
                        <p><strong>Asignación:</strong> Asignar ítem a un colaborador</p>
                        <p><strong>Préstamo:</strong> Préstamo temporal con fecha de devolución</p>
                        <p><strong>Mantenimiento:</strong> Envío a reparación (puede tener reemplazo)</p>
                        <p><strong>Garantía:</strong> Envío a garantía del fabricante</p>
                        <p><strong>Reemplazo:</strong> Cambio definitivo de equipo</p>
                        <p class="mb-0"><strong>Devolución Leasing:</strong> Retorno por fin de contrato</p>
                    </div>
                </div>

                <!-- Acciones -->
                <div class="card">
                    <div class="card-body">
                        <button type="submit" class="btn btn-primary w-100 mb-2" id="btnEnviar">
                            <i class="fas fa-paper-plane me-1"></i> Enviar Solicitud
                        </button>
                        <a href="{% if item %}{% url 'productos:item-detail' item.codigo_utp %}{% else %}{% url 'productos:movimiento-list' %}{% endif %}" class="btn btn-light w-100">
                            Cancelar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoSelect = document.getElementById('id_tipo');
    const seccionDestino = document.getElementById('seccionDestino');
    const seccionColaborador = document.getElementById('seccionColaborador');
    const seccionReemplazo = document.getElementById('seccionReemplazo');
    const seccionEstadoFinal = document.getElementById('seccionEstadoFinal');
    const campoFechaDevolucion = document.getElementById('campoFechaDevolucion');
    const pasoTransito = document.getElementById('pasoTransito');

    // Campos de búsqueda
    const buscarInput = document.getElementById('buscarItem');
    const sugerenciasDiv = document.getElementById('sugerenciasItem');
    const btnEnviar = document.getElementById('btnEnviar');

    // Contenedores de ítems seleccionados
    const itemsHiddenContainer = document.getElementById('itemsHiddenContainer');
    const listaItemsSeleccionados = document.getElementById('listaItemsSeleccionados');
    const contadorItems = document.getElementById('contadorItems');
    const mensajeSinItems = document.getElementById('mensajeSinItems');
    const btnLimpiarItems = document.getElementById('btnLimpiarItems');

    // Campos en cascada destino
    const campusDestino = document.getElementById('id_campus_destino');
    const sedeDestino = document.getElementById('id_sede_destino');
    const pabellonDestino = document.getElementById('id_pabellon_destino');
    const ambienteDestino = document.getElementById('id_ambiente_destino');

    // Filtros
    const filtroCampus = document.getElementById('filtro_campus');
    const filtroSede = document.getElementById('filtro_sede');
    const filtroArea = document.getElementById('filtro_area');
    const filtroTipo = document.getElementById('filtro_tipo');

    let timeoutBusqueda = null;
    let itemsSeleccionados = new Map(); // Map de id -> datos del item

    // Inicializar con ítem preseleccionado si existe
    {% if item %}
    itemsSeleccionados.set({{ item.pk }}, {
        id: {{ item.pk }},
        codigo_utp: '{{ item.codigo_utp }}',
        nombre: '{{ item.nombre }}',
        serie: '{{ item.serie|default:"-" }}',
        area: '{{ item.area.nombre }}',
        estado_display: '{{ item.get_estado_display }}',
        ubicacion: '{% if item.ambiente %}{{ item.ambiente.pabellon.sede.campus.nombre }} » {{ item.ambiente.pabellon.sede.nombre }} » Pab. {{ item.ambiente.pabellon.letra }} - {{ item.ambiente.nombre }}{% else %}Sin ubicación{% endif %}'
    });
    {% endif %}

    // ===== FUNCIONES DE GESTIÓN DE ÍTEMS =====
    function actualizarContador() {
        const count = itemsSeleccionados.size;
        contadorItems.textContent = count;

        // Mostrar/ocultar mensaje vacío y botón limpiar
        if (mensajeSinItems) {
            mensajeSinItems.style.display = count === 0 ? 'block' : 'none';
        }
        if (btnLimpiarItems) {
            btnLimpiarItems.style.display = count > 0 ? 'inline-block' : 'none';
        }

        // Habilitar/deshabilitar botón enviar
        btnEnviar.disabled = count === 0;
    }

    function agregarItem(item) {
        // Verificar si ya está seleccionado
        if (itemsSeleccionados.has(item.id)) {
            alert('Este ítem ya está seleccionado');
            return;
        }

        // Agregar al Map
        itemsSeleccionados.set(item.id, item);

        // Crear campo hidden
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'items';
        hiddenInput.value = item.id;
        hiddenInput.dataset.itemId = item.id;
        itemsHiddenContainer.appendChild(hiddenInput);

        // Crear elemento visual
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item-seleccionado border rounded p-3 mb-2';
        itemDiv.dataset.itemId = item.id;
        itemDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>${item.codigo_utp}</strong> - ${item.nombre}
                    <br><small class="text-muted">Serie: ${item.serie || '-'} | ${item.area}</small>
                    <br><small class="text-muted">
                        <i class="fas fa-map-marker-alt me-1"></i>${item.ubicacion || 'Sin ubicación'}
                    </small>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-secondary">${item.estado_display}</span>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-quitar-item" data-item-id="${item.id}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        listaItemsSeleccionados.appendChild(itemDiv);

        // Agregar evento al botón quitar
        itemDiv.querySelector('.btn-quitar-item').addEventListener('click', function() {
            quitarItem(item.id);
        });

        actualizarContador();

        // Limpiar búsqueda
        if (buscarInput) {
            buscarInput.value = '';
            buscarInput.focus();
        }
    }

    function quitarItem(itemId) {
        // Quitar del Map
        itemsSeleccionados.delete(itemId);

        // Quitar campo hidden
        const hiddenInput = itemsHiddenContainer.querySelector(`input[data-item-id="${itemId}"]`);
        if (hiddenInput) hiddenInput.remove();

        // Quitar elemento visual
        const itemDiv = listaItemsSeleccionados.querySelector(`.item-seleccionado[data-item-id="${itemId}"]`);
        if (itemDiv) itemDiv.remove();

        actualizarContador();
    }

    function limpiarTodosItems() {
        itemsSeleccionados.clear();
        itemsHiddenContainer.innerHTML = '';
        listaItemsSeleccionados.querySelectorAll('.item-seleccionado').forEach(el => el.remove());
        actualizarContador();
    }

    // Evento para limpiar todos los ítems
    if (btnLimpiarItems) {
        btnLimpiarItems.addEventListener('click', function() {
            if (confirm('¿Está seguro de quitar todos los ítems seleccionados?')) {
                limpiarTodosItems();
            }
        });
    }

    // ===== AUTOCOMPLETADO DE ÍTEMS =====
    if (buscarInput) {
        buscarInput.addEventListener('input', function() {
            clearTimeout(timeoutBusqueda);
            const query = this.value.trim();

            if (query.length < 2) {
                sugerenciasDiv.style.display = 'none';
                return;
            }

            timeoutBusqueda = setTimeout(() => {
                buscarItems(query);
            }, 300);
        });

        buscarInput.addEventListener('blur', function() {
            setTimeout(() => {
                sugerenciasDiv.style.display = 'none';
            }, 200);
        });
    }

    function buscarItems(query) {
        // Verificar que se haya seleccionado un tipo de movimiento
        const tipoMovimiento = tipoSelect ? tipoSelect.value : '';
        if (!tipoMovimiento) {
            sugerenciasDiv.innerHTML = '<div class="list-group-item text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Primero seleccione el tipo de movimiento</div>';
            sugerenciasDiv.style.display = 'block';
            return;
        }

        let url = '{% url "productos:api-items-buscar" %}?q=' + encodeURIComponent(query);

        // Añadir tipo de movimiento para filtrar ítems disponibles
        url += '&tipo_movimiento=' + tipoMovimiento;

        // Añadir filtros si están activos
        if (filtroCampus && filtroCampus.value) url += '&campus=' + filtroCampus.value;
        if (filtroSede && filtroSede.value) url += '&sede=' + filtroSede.value;
        if (filtroArea && filtroArea.value) url += '&area=' + filtroArea.value;
        if (filtroTipo && filtroTipo.value) url += '&tipo=' + filtroTipo.value;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                mostrarSugerencias(data.items);
            })
            .catch(error => {
                console.error('Error buscando ítems:', error);
            });
    }

    function mostrarSugerencias(items) {
        sugerenciasDiv.innerHTML = '';

        if (items.length === 0) {
            sugerenciasDiv.innerHTML = '<div class="list-group-item text-muted">No se encontraron ítems</div>';
            sugerenciasDiv.style.display = 'block';
            return;
        }

        items.forEach(item => {
            const yaSeleccionado = itemsSeleccionados.has(item.id);
            const div = document.createElement('a');
            div.href = '#';
            div.className = 'list-group-item list-group-item-action' + (yaSeleccionado ? ' bg-light' : '');
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${item.codigo_utp}</strong> - ${item.nombre}
                        <br><small class="text-muted">${item.serie || 'Sin serie'} | ${item.area}</small>
                    </div>
                    <div>
                        <span class="badge bg-secondary">${item.estado_display}</span>
                        ${yaSeleccionado ? '<span class="badge bg-success ms-1"><i class="fas fa-check"></i></span>' : ''}
                    </div>
                </div>
                <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>${item.ubicacion || 'Sin ubicación'}</small>
            `;
            div.addEventListener('click', function(e) {
                e.preventDefault();
                if (!yaSeleccionado) {
                    agregarItem(item);
                    sugerenciasDiv.style.display = 'none';
                }
            });
            sugerenciasDiv.appendChild(div);
        });

        sugerenciasDiv.style.display = 'block';
    }

    // ===== CASCADA DE UBICACIÓN DESTINO =====
    if (campusDestino) {
        campusDestino.addEventListener('change', function() {
            const campusId = this.value;
            sedeDestino.innerHTML = '<option value="">---------</option>';
            pabellonDestino.innerHTML = '<option value="">---------</option>';
            ambienteDestino.innerHTML = '<option value="">---------</option>';

            if (!campusId) return;

            fetch('{% url "productos:api-sedes" %}?campus_id=' + campusId)
                .then(response => response.json())
                .then(data => {
                    data.forEach(sede => {
                        const option = document.createElement('option');
                        option.value = sede.id;
                        option.textContent = sede.nombre;
                        sedeDestino.appendChild(option);
                    });
                });
        });
    }

    if (sedeDestino) {
        sedeDestino.addEventListener('change', function() {
            const sedeId = this.value;
            pabellonDestino.innerHTML = '<option value="">---------</option>';
            ambienteDestino.innerHTML = '<option value="">---------</option>';

            if (!sedeId) return;

            fetch('{% url "productos:api-pabellones" %}?sede_id=' + sedeId)
                .then(response => response.json())
                .then(data => {
                    data.forEach(pabellon => {
                        const option = document.createElement('option');
                        option.value = pabellon.id;
                        option.textContent = pabellon.nombre;
                        pabellonDestino.appendChild(option);
                    });
                });
        });
    }

    if (pabellonDestino) {
        pabellonDestino.addEventListener('change', function() {
            const pabellonId = this.value;
            ambienteDestino.innerHTML = '<option value="">---------</option>';

            if (!pabellonId) return;

            fetch('{% url "productos:api-ambientes" %}?pabellon_id=' + pabellonId)
                .then(response => response.json())
                .then(data => {
                    data.forEach(ambiente => {
                        const option = document.createElement('option');
                        option.value = ambiente.id;
                        option.textContent = `${ambiente.nombre} (Piso ${ambiente.piso})`;
                        ambienteDestino.appendChild(option);
                    });
                });
        });
    }

    // ===== FILTROS AVANZADOS =====
    if (filtroCampus) {
        filtroCampus.addEventListener('change', function() {
            const campusId = this.value;
            filtroSede.innerHTML = '<option value="">Todas</option>';
            filtroSede.disabled = !campusId;

            if (!campusId) return;

            fetch('{% url "productos:api-sedes" %}?campus_id=' + campusId)
                .then(response => response.json())
                .then(data => {
                    data.forEach(sede => {
                        const option = document.createElement('option');
                        option.value = sede.id;
                        option.textContent = sede.nombre;
                        filtroSede.appendChild(option);
                    });
                });
        });
    }

    if (filtroArea) {
        filtroArea.addEventListener('change', function() {
            const areaId = this.value;
            filtroTipo.innerHTML = '<option value="">Todos</option>';

            if (!areaId) return;

            fetch('{% url "productos:api-tipos-item" %}?area=' + areaId)
                .then(response => response.json())
                .then(data => {
                    data.forEach(tipo => {
                        const option = document.createElement('option');
                        option.value = tipo.id;
                        option.textContent = tipo.nombre;
                        filtroTipo.appendChild(option);
                    });
                });
        });
    }

    const btnBuscarConFiltros = document.getElementById('btnBuscarConFiltros');
    if (btnBuscarConFiltros) {
        btnBuscarConFiltros.addEventListener('click', function() {
            if (buscarInput.value.trim().length >= 2) {
                buscarItems(buscarInput.value.trim());
            } else {
                buscarItems('');
            }
        });
    }

    const btnLimpiarFiltros = document.getElementById('btnLimpiarFiltros');
    if (btnLimpiarFiltros) {
        btnLimpiarFiltros.addEventListener('click', function() {
            if (filtroCampus) filtroCampus.value = '';
            if (filtroSede) {
                filtroSede.innerHTML = '<option value="">Todas</option>';
                filtroSede.disabled = true;
            }
            if (filtroArea) filtroArea.value = '';
            if (filtroTipo) filtroTipo.innerHTML = '<option value="">Todos</option>';
        });
    }

    // ===== VISIBILIDAD POR TIPO DE MOVIMIENTO =====
    function updateVisibilidad() {
        const tipo = tipoSelect ? tipoSelect.value : '';

        // Ocultar todas las secciones primero
        if (seccionDestino) seccionDestino.style.display = 'none';
        if (seccionColaborador) seccionColaborador.style.display = 'none';
        if (seccionReemplazo) seccionReemplazo.style.display = 'none';
        if (seccionEstadoFinal) seccionEstadoFinal.style.display = 'none';
        if (campoFechaDevolucion) campoFechaDevolucion.style.display = 'none';
        if (pasoTransito) pasoTransito.style.display = 'flex';

        // Mostrar secciones según tipo de movimiento
        switch(tipo) {
            case 'traslado':
                seccionDestino.style.display = 'block';
                break;

            case 'asignacion':
                seccionColaborador.style.display = 'block';
                seccionDestino.style.display = 'block';
                pasoTransito.style.display = 'none';
                break;

            case 'prestamo':
                seccionColaborador.style.display = 'block';
                campoFechaDevolucion.style.display = 'block';
                seccionDestino.style.display = 'block';
                pasoTransito.style.display = 'none';
                break;

            case 'mantenimiento':
            case 'garantia':
                seccionReemplazo.style.display = 'block';
                seccionEstadoFinal.style.display = 'block';
                pasoTransito.style.display = 'none';
                break;

            case 'reemplazo':
                seccionReemplazo.style.display = 'block';
                seccionEstadoFinal.style.display = 'block';
                seccionColaborador.style.display = 'block';
                pasoTransito.style.display = 'none';
                break;

            case 'leasing':
                seccionEstadoFinal.style.display = 'block';
                pasoTransito.style.display = 'none';
                break;

            default:
                // Sin tipo seleccionado, mostrar destino por defecto
                seccionDestino.style.display = 'block';
                break;
        }
    }

    if (tipoSelect) {
        tipoSelect.addEventListener('change', function() {
            updateVisibilidad();

            // Limpiar ítems seleccionados cuando cambie el tipo de movimiento
            // ya que los ítems válidos pueden variar según el tipo
            if (itemsSeleccionados.size > 0) {
                if (confirm('Al cambiar el tipo de movimiento se limpiarán los ítems seleccionados. ¿Desea continuar?')) {
                    limpiarTodosItems();
                } else {
                    // Revertir la selección (esto es complicado, mejor solo avisar)
                }
            }
        });
    }

    // Inicializar visibilidad y contador
    updateVisibilidad();
    actualizarContador();
});
</script>
{% endblock %}
