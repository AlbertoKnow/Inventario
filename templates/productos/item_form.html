{% extends "base.html" %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'productos:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'productos:item-list' %}">Inventario</a></li>
            <li class="breadcrumb-item active">{{ titulo }}</li>
        </ol>
    </nav>
    
    <div class="page-header mb-4">
        <h1>{{ titulo }}</h1>
    </div>
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        {% if form.errors %}
        <div class="alert alert-danger mb-4">
            <i class="fas fa-exclamation-circle me-2"></i>
            Por favor corrige los errores indicados.
            <ul class="mb-0 mt-2">
                {% for field in form %}
                    {% for error in field.errors %}
                    <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        <div class="row">
            <div class="col-lg-8">
                <!-- Información Básica -->
                <div class="card mb-4">
                    <div class="card-header">Información Básica</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Código UTP</label>
                                {{ form.codigo_utp }}
                                {% if form.codigo_utp.errors %}
                                <div class="text-danger small">{{ form.codigo_utp.errors.0 }}</div>
                                {% endif %}
                                <small class="text-muted">Código de etiqueta física. Ej: UTP296375. <strong>Dejar vacío si aún no tiene etiqueta</strong> (se guardará como PENDIENTE).</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Número de Serie <span class="text-danger">*</span></label>
                                {{ form.serie }}
                                {% if form.serie.errors %}
                                <div class="text-danger small">{{ form.serie.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Nombre <span class="text-danger">*</span></label>
                                {{ form.nombre }}
                                {% if form.nombre.errors %}
                                <div class="text-danger small">{{ form.nombre.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-12">
                                <label class="form-label">Descripción</label>
                                {{ form.descripcion }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Clasificación -->
                <div class="card mb-4">
                    <div class="card-header">Clasificación</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Área <span class="text-danger">*</span></label>
                                {{ form.area }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tipo de Ítem <span class="text-danger">*</span></label>
                                {{ form.tipo_item }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ubicación -->
                <div class="card mb-4">
                    <div class="card-header">Ubicación</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Campus</label>
                                {{ form.campus }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Sede</label>
                                {{ form.sede }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pabellón</label>
                                {{ form.pabellon }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ambiente</label>
                                {{ form.ambiente }}
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-info-circle me-1"></i>
                            Seleccione Campus → Sede → Pabellón → Ambiente de forma jerárquica
                        </small>
                    </div>
                </div>
                
                <!-- Estado y Asignación -->
                <div class="card mb-4">
                    <div class="card-header">Estado y Asignación</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Estado <span class="text-danger">*</span></label>
                                {{ form.estado }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Usuario Asignado</label>
                                {{ form.usuario_asignado }}
                            </div>
                            <div class="col-12">
                                <label class="form-label">Observaciones</label>
                                {{ form.observaciones }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Garantía -->
                <div class="card mb-4">
                    <div class="card-header">Garantía</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Garantía hasta</label>
                                {{ form.garantia_hasta }}
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Fecha de vencimiento de la garantía del fabricante
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Leasing -->
                <div class="card mb-4">
                    <div class="card-header">Leasing</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.es_leasing }}
                                    <label class="form-check-label" for="id_es_leasing">Es un ítem en leasing</label>
                                </div>
                            </div>
                            <div class="col-md-6" id="leasing-fields">
                                <label class="form-label">Vencimiento del Leasing</label>
                                {{ form.leasing_vencimiento }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Especificaciones Técnicas (Solo Sistemas) -->
                <div class="card mb-4" id="card-especificaciones" style="display: none;">
                    <div class="card-header bg-dark text-white">
                        <i class="fas fa-microchip me-2"></i>Especificaciones Técnicas
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Marca</label>
                                {{ form.marca }}
                                <small class="text-muted">Escriba para ver sugerencias</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Modelo</label>
                                {{ form.modelo }}
                                <small class="text-muted">Sugerencias basadas en marca</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Procesador</label>
                                {{ form.procesador }}
                                <small class="text-muted">Escriba para ver sugerencias</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Generación</label>
                                {{ form.generacion_procesador }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">RAM (GB)</label>
                                {{ form.ram_total_gb }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Configuración RAM</label>
                                {{ form.ram_configuracion }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tipo RAM</label>
                                {{ form.ram_tipo }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Almacenamiento</label>
                                {{ form.almacenamiento_gb }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tipo Disco</label>
                                {{ form.almacenamiento_tipo }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Sistema Operativo</label>
                                {{ form.sistema_operativo }}
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-info-circle me-1"></i>
                            Estos campos son opcionales. Los valores con autocompletado sugieren opciones basadas en registros anteriores.
                        </small>
                    </div>
                </div>

                <!-- Datalists para autocompletado -->
                <datalist id="marcas-list"></datalist>
                <datalist id="modelos-list"></datalist>
                <datalist id="procesadores-list"></datalist>

            </div>
            
            <div class="col-lg-4">
                <!-- Sidebar sticky -->
                <div style="position: sticky; top: 20px;">
                    <!-- Ayuda -->
                    <div class="card mb-4">
                        <div class="card-header">Ayuda</div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                Complete los campos requeridos marcados con <span class="text-danger">*</span>
                            </p>
                            <ul class="text-muted small ps-3 mb-0">
                                <li>El código UTP es la etiqueta física del activo</li>
                                <li>Déjelo vacío si aún no tiene etiqueta</li>
                                <li>El número de serie debe ser único</li>
                                <li>Seleccione el área antes del tipo de ítem</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Acciones -->
                    <div class="card">
                        <div class="card-body">
                            <button type="submit" class="btn btn-primary w-100 mb-2">
                                <i class="fas fa-save me-1"></i> Guardar
                            </button>
                            <a href="{% url 'productos:item-list' %}" class="btn btn-light w-100">
                                Cancelar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar tipos de ítem según el área seleccionada
    const areaSelect = document.getElementById('id_area');
    const tipoSelect = document.getElementById('id_tipo_item');
    const cardEspecificaciones = document.getElementById('card-especificaciones');

    // Función para mostrar/ocultar especificaciones según el área
    function toggleEspecificaciones() {
        if (!areaSelect || !cardEspecificaciones) return;

        const selectedOption = areaSelect.options[areaSelect.selectedIndex];
        const areaText = selectedOption ? selectedOption.text.toLowerCase() : '';

        if (areaText.includes('sistema')) {
            cardEspecificaciones.style.display = 'block';
        } else {
            cardEspecificaciones.style.display = 'none';
        }
    }

    // Ejecutar al cargar la página
    toggleEspecificaciones();

    if (areaSelect && tipoSelect) {
        areaSelect.addEventListener('change', function() {
            const areaId = this.value;

            // Mostrar/ocultar especificaciones
            toggleEspecificaciones();

            if (areaId) {
                fetch(`/productos/api/tipos-item/?area=${areaId}`)
                    .then(response => response.json())
                    .then(data => {
                        tipoSelect.innerHTML = '<option value="">---------</option>';
                        data.tipos.forEach(tipo => {
                            const option = document.createElement('option');
                            option.value = tipo.id;
                            option.textContent = tipo.nombre;
                            tipoSelect.appendChild(option);
                        });
                    });
            }
        });
    }
    
    // ========================================
    // Dropdowns en cascada para ubicación
    // ========================================
    const campusSelect = document.getElementById('id_campus');
    const sedeSelect = document.getElementById('id_sede');
    const pabellonSelect = document.getElementById('id_pabellon');
    const ambienteSelect = document.getElementById('id_ambiente');
    
    function loadOptions(url, params, targetSelect, placeholder) {
        const urlWithParams = url + '?' + new URLSearchParams(params);
        
        fetch(urlWithParams)
            .then(response => response.json())
            .then(data => {
                targetSelect.innerHTML = '<option value="">-- ' + placeholder + ' --</option>';
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.nombre;
                    targetSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error:', error));
    }
    
    // Cuando cambia el Campus, cargar Sedes
    if (campusSelect) {
        campusSelect.addEventListener('change', function() {
            const campusId = this.value;
            sedeSelect.innerHTML = '<option value="">-- Seleccione Sede --</option>';
            pabellonSelect.innerHTML = '<option value="">-- Seleccione Pabellón --</option>';
            ambienteSelect.innerHTML = '<option value="">-- Seleccione Ambiente --</option>';
            
            if (campusId) {
                loadOptions('/productos/api/sedes/', {campus_id: campusId}, sedeSelect, 'Seleccione Sede');
            }
        });
    }
    
    // Cuando cambia la Sede, cargar Pabellones
    if (sedeSelect) {
        sedeSelect.addEventListener('change', function() {
            const sedeId = this.value;
            pabellonSelect.innerHTML = '<option value="">-- Seleccione Pabellón --</option>';
            ambienteSelect.innerHTML = '<option value="">-- Seleccione Ambiente --</option>';
            
            if (sedeId) {
                loadOptions('/productos/api/pabellones/', {sede_id: sedeId}, pabellonSelect, 'Seleccione Pabellón');
            }
        });
    }
    
    // Cuando cambia el Pabellón, cargar Ambientes
    if (pabellonSelect) {
        pabellonSelect.addEventListener('change', function() {
            const pabellonId = this.value;
            ambienteSelect.innerHTML = '<option value="">-- Seleccione Ambiente --</option>';

            if (pabellonId) {
                loadOptions('/productos/api/ambientes/', {pabellon_id: pabellonId}, ambienteSelect, 'Seleccione Ambiente');
            }
        });
    }

    // ========================================
    // Filtrar configuración RAM según cantidad
    // ========================================
    const ramGbSelect = document.getElementById('id_ram_total_gb');
    const ramConfigSelect = document.getElementById('id_ram_configuracion');

    // Configuraciones válidas por cantidad de RAM
    const ramConfigPorGb = {
        '4': ['1x4GB', '2x2GB'],
        '8': ['1x8GB', '2x4GB'],
        '16': ['1x16GB', '2x8GB'],
        '32': ['2x16GB', '4x8GB'],
        '64': ['2x32GB', '4x16GB']
    };

    function filtrarConfiguracionRam() {
        if (!ramGbSelect || !ramConfigSelect) return;

        const ramGb = ramGbSelect.value;
        const currentValue = ramConfigSelect.value;

        // Guardar todas las opciones originales si no existen
        if (!ramConfigSelect.allOptions) {
            ramConfigSelect.allOptions = Array.from(ramConfigSelect.options).map(opt => ({
                value: opt.value,
                text: opt.text
            }));
        }

        // Limpiar opciones
        ramConfigSelect.innerHTML = '<option value="">---------</option>';

        if (ramGb && ramConfigPorGb[ramGb]) {
            // Agregar solo las configuraciones válidas para esa RAM
            ramConfigPorGb[ramGb].forEach(config => {
                const option = document.createElement('option');
                option.value = config;
                option.text = config;
                if (config === currentValue) option.selected = true;
                ramConfigSelect.appendChild(option);
            });
        } else {
            // Si no hay RAM seleccionada, mostrar todas las opciones
            ramConfigSelect.allOptions.forEach(opt => {
                if (opt.value) {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.text = opt.text;
                    if (opt.value === currentValue) option.selected = true;
                    ramConfigSelect.appendChild(option);
                }
            });
        }
    }

    // Ejecutar al cargar y cuando cambie RAM
    if (ramGbSelect) {
        filtrarConfiguracionRam();
        ramGbSelect.addEventListener('change', filtrarConfiguracionRam);
    }

    // ========================================
    // Autocompletado para especificaciones
    // ========================================
    const marcaInput = document.getElementById('id_marca');
    const modeloInput = document.getElementById('id_modelo');
    const procesadorInput = document.getElementById('id_procesador');

    const marcasList = document.getElementById('marcas-list');
    const modelosList = document.getElementById('modelos-list');
    const procesadoresList = document.getElementById('procesadores-list');

    // Cargar opciones de autocompletado desde el API
    function cargarOpcionesAutocompletado() {
        fetch('/productos/api/especificaciones-valores/')
            .then(response => response.json())
            .then(data => {
                // Poblar datalist de marcas
                if (marcasList && data.marcas) {
                    marcasList.innerHTML = '';
                    data.marcas.forEach(marca => {
                        const option = document.createElement('option');
                        option.value = marca;
                        marcasList.appendChild(option);
                    });
                }

                // Poblar datalist de modelos
                if (modelosList && data.modelos) {
                    modelosList.innerHTML = '';
                    data.modelos.forEach(modelo => {
                        const option = document.createElement('option');
                        option.value = modelo;
                        modelosList.appendChild(option);
                    });
                }

                // Poblar datalist de procesadores
                if (procesadoresList && data.procesadores) {
                    procesadoresList.innerHTML = '';
                    data.procesadores.forEach(proc => {
                        const option = document.createElement('option');
                        option.value = proc;
                        procesadoresList.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error cargando opciones de autocompletado:', error));
    }

    // Actualizar modelos cuando cambie la marca
    function actualizarModelosPorMarca(marca) {
        if (!marca || !modelosList) return;

        fetch(`/productos/api/especificaciones-valores/?marca=${encodeURIComponent(marca)}`)
            .then(response => response.json())
            .then(data => {
                if (data.modelos) {
                    modelosList.innerHTML = '';
                    data.modelos.forEach(modelo => {
                        const option = document.createElement('option');
                        option.value = modelo;
                        modelosList.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error actualizando modelos:', error));
    }

    // Evento cuando cambia la marca
    if (marcaInput) {
        marcaInput.addEventListener('change', function() {
            actualizarModelosPorMarca(this.value);
        });

        // También actualizar al escribir (con debounce)
        let marcaTimeout;
        marcaInput.addEventListener('input', function() {
            clearTimeout(marcaTimeout);
            marcaTimeout = setTimeout(() => {
                if (this.value.length >= 2) {
                    actualizarModelosPorMarca(this.value);
                }
            }, 300);
        });
    }

    // Cargar opciones al inicio si el área es Sistemas
    const selectedAreaText = areaSelect ?
        (areaSelect.options[areaSelect.selectedIndex] ? areaSelect.options[areaSelect.selectedIndex].text.toLowerCase() : '')
        : '';

    if (selectedAreaText.includes('sistema')) {
        cargarOpcionesAutocompletado();
    }

    // También cargar cuando se selecciona Sistemas
    if (areaSelect) {
        areaSelect.addEventListener('change', function() {
            const areaText = this.options[this.selectedIndex] ? this.options[this.selectedIndex].text.toLowerCase() : '';
            if (areaText.includes('sistema')) {
                cargarOpcionesAutocompletado();
            }
        });
    }
});
</script>
{% endblock %}
